
 @*------------------------------------------------------------------------------
 *     此代码由T4模板自动生成
 *	   生成时间 2018-09-20 15:25:56
 *     ©为之团队
 *------------------------------------------------------------------------------*@

 @{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Index.cshtml";
}
<script>
    $(function () {
        gridList();
    })
    function gridList() {
        var $gridList = $("#gridList");
        $gridList.dataGrid({
            url: "/TN_XM/TN_HT_CG/GetGridJson",
            height: $(window).height() - 180,
            colModel: [
					  	
					{ label: "主键", name: "Id", width: 150, align: 'left', hidden: true },

					{ label: "BindId", name: "BindId", width: 150, align: 'left', hidden: true },

                    { label: "采购组织", name: "CGOrganization", width: 150, align: 'left' },

					{ label: "合同编码", name: "Code", width: 150, align: 'left' },

					{ label: "合同名称", name: "Name", width: 150, align: 'left' },

					{ label: "合同类型", name: "HTType", width: 150, align: 'left' },

					{ label: "设备包", name: "CPpackage", width: 150, align: 'left' },

                    { label: "合同金额（元）", name: "Amount", width: 150, align: 'right' },

					{ label: "支付方式", name: "PayType", width: 150, align: 'left' },

                { label: "已付金额（元）", name: "paidAmount", width: 150, align: 'right' },

                { label: "未付金额（元）", name: "unpaidAmount", width: 150, align: 'right' },

                    {
                        label: "支付比例", name: "PayProportion", width: 150, align: 'right',
                        formatter: function (cellvalue, options, rowObject) {
                            var paid = parseFloat(rowObject.paidAmount) / parseFloat(rowObject.Amount) * 100;
                            var per = paid.toFixed(2);
                            return per + "%";
                        }
                    },

                    { label: "资金来源", name: "FundSource", width: 150, align: 'left' },

					{ label: "计划终止日期", name: "EndTime", width: 150, align: 'left' },

					{ label: "供应商", name: "Supplier", width: 150, align: 'left' },

					{ label: "币种", name: "currency", width: 150, align: 'left' },

					{ label: "合同签订日期", name: "SigningDate", width: 150, align: 'left' },

					{ label: "部门", name: "Department", width: 150, align: 'left' },

					{ label: "人员", name: "Personnel", width: 150, align: 'left' },

					{ label: "交货地点", name: "Place", width: 150, align: 'left' },

                { label: "预付款（元）", name: "AdvancePayment", width: 150, align: 'right' },

                { label: "预付款限额 ", name: "Limit", width: 150, align: 'right' },

					{ label: "合同状态", name: "HTState", width: 150, align: 'left' },

					{ label: "创建时间", name: "CreateDate", width: 150, align: 'left' },

					{ label: "创建人ID", name: "CreateUserId", width: 150, align: 'left', hidden: true },

					{ label: "创建人姓名", name: "CreateUserName", width: 150, align: 'left' },

					{ label: "更新时间", name: "UpdateDate", width: 150, align: 'left', hidden: true },

					{ label: "更新人ID", name: "UpdateUserId", width: 150, align: 'left', hidden: true },

					{ label: "更新人姓名", name: "UpdateUserName", width: 150, align: 'left', hidden: true },
 
            ],
			pager: "#gridPager",
            sortname: 'CreateDate asc',
            viewrecord: true,
            subGrid: true,//开启子表格支持 
            subGridOptions: {
                expandOnLoad: true,
                selectOnExpand: false,
                reloadOnExpand: false
            },
            subGridRowExpanded: function (subgrid_id, row_id_) {//子表格容器的id和需要展开子表格的行id
                bindSubGrid(subgrid_id, row_id_);
            }
        });
        $("#btn_search").click(function () {
			var queryJson = {
			    keyword: $("#txt_keyword").val(),
			    CPpackage: $("#CPpackage").val(),
			    Code: $("#Code").val(),
			    Name: $("#Name").val()
            }
		    $gridList.jqGrid('setGridParam', {
		         postData: { queryJson: JSON.stringify(queryJson) }, page: 1
		    }).trigger('reloadGrid');
        });
    }

    //子表信息
    function bindSubGrid(subgrid_id, row_id) {
        var subgrid_table_id;
        subgrid_table_id = subgrid_id + "_t";
        subgrid_pager_id = subgrid_id + "_y"; 
        $("#" + subgrid_id).html("<table id='" + subgrid_table_id + "' class='scroll'></table><div id='" + subgrid_pager_id + "' ></div>");
        //$("#" + subgrid_id).html("<div id='" + subgrid_pager_id + "' ></div>");
        $gridList_measure_sub = $("#" + subgrid_table_id);
        $gridList_measure = $("#gridList");
        var rowData = $gridList_measure.getRowData(row_id);
        var queryJson = {
            Id: rowData.Id
        };
        $gridList_measure_sub.dataGrid({
            url: "/TN_XM/TN_XM/GetGridJson3",
            postData: { queryJson: JSON.stringify(queryJson) },
            height: $(window).height() - 188,
            colModel: [

					{ label: "主键", name: "Id", width: 150, align: 'left', hidden: true },

					{ label: "BindId", name: "BindId", width: 150, align: 'left', hidden: true },

					{ label: "主项目名称", name: "BaseName", width: 200, align: 'left' },

					{ label: "子项目名称", name: "BaseSubName", width: 200, align: 'left' },

                    {
                        label: "项目编码", name: "Code", width: 200, align: 'left',
                        formatter: function (cellvalue, options, rowObject) {
                            var code = rowObject.RulesCode + "-" + rowObject.Code;
                            return code;
                        }
                    },

                    { label: "编码前缀", name: "RulesCode", width: 200, align: 'left', hidden: true },

                   	{ label: "项目实施内容", name: "Name", width: 150, align: 'left' },

                    { label: "所属公司", name: "CompanyName", width: 150, align: 'left' },

                    { label: "设备包", name: "CPpackage", width: 150, align: 'left' },

					{ label: "项目状态", name: "ProjectState", width: 150, align: 'left' },

    				{ label: "创建日期", name: "CreateDate", width: 150, align: 'left' },

					{ label: "创建用户", name: "CreateUserName", width: 150, align: 'left' },

					{ label: "开始时间", name: "BeginDate", width: 150, align: 'left' },

					{ label: "结束时间", name: "EndDate", width: 150, align: 'left' },

					{ label: "项目描述", name: "DEC", width: 150, align: 'left' },

					{ label: "项目负责人", name: "Principal", width: 150, align: 'left' },

					{ label: "项目负责人电话", name: "Phone", width: 150, align: 'left' },

					{ label: "施工单位", name: "ConstructionUnit", width: 150, align: 'left' },

					{ label: "施工单位负责人", name: "CPrincipal", width: 150, align: 'left' },

					{ label: "施工单位负责人电话", name: "CPhone", width: 150, align: 'left' },

					{ label: "备注", name: "Remark", width: 150, align: 'left' },

            ],
            //data: colModels_Data,
            pager: "#"+ subgrid_pager_id ,
            sortname: 'CreateDate desc',
            datatype: "json",
            viewrecord: true,
            subGrid: true,//开启子表格支持 
            subGridOptions: {
                expandOnLoad: true,
                selectOnExpand: false,
                reloadOnExpand: false
            },
            subGridRowExpanded: function (subgrid_id, row_id_) {//子表格容器的id和需要展开子表格的行id
                bindSubGrid1(subgrid_id, row_id_);
            }
    });
    }

    //子表信息
    function bindSubGrid1(subgrid_id, row_id) {
        var subgrid_table_id;
        subgrid_table_id = subgrid_id + "_t";
        subgrid_pager_id = subgrid_id + "_y";
        $("#" + subgrid_id).html("<table id='" + subgrid_table_id + "' class='scroll'></table><div id='" + subgrid_pager_id + "' ></div>");
        var subid = subgrid_id.substr(0,12); 
        //$("#" + subgrid_id).html("<div id='" + subgrid_pager_id + "' ></div>");
        $gridList_measure_sub = $("#" + subgrid_table_id);
        $gridList_measure = $("#" + subid);
        var rowData = $gridList_measure.getRowData(row_id);
        var queryJson = {
            ProjectNo: rowData.Code
        };
        $gridList_measure_sub.jqGrid({
            url: "/TN_XM/TN_CG_CP/GetGridJson6",
            postData: { queryJson: JSON.stringify(queryJson) },
            height: '300px',
            colModel: [
                     { label: "主键", name: "Id", width: 150, align: 'left', hidden: true },

                     { label: "BindId", name: "BindId", width: 150, align: 'left', hidden: true },

                     { label: "项目编码", name: "ProjectNo", width: 150, align: 'left', hidden: true },

                     { label: "项目名称", name: "ProjectName", width: 150, align: 'left' },

                     { label: "设备包", name: "CPpackage", width: 150, align: 'left' },

                     { label: "设备分类", name: "Classify", width: 150, align: 'left' },

                     { label: "设备编码", name: "CPCode", width: 150, align: 'left' },

                     { label: "设备名称", name: "Name", width: 150, align: 'left' },

                     { label: "规格及型号", name: "Specifications", width: 150, align: 'left' },

                     { label: "型号", name: "Model", width: 150, align: 'left', hidden: true },

                     { label: "单位", name: "Unit", width: 150, align: 'left' },

                     { label: "数量", name: "Quantity", width: 150, align: 'left' },

                     { label: "已付款数量", name: "PayQuantity", width: 150, align: 'left' },

                     { label: "出厂价格（元）", name: "TaxPrice", width: 150, align: 'left' },

                     { label: "税率（%）", name: "Rate", width: 150, align: 'left' },

                     { label: "每一品目出厂价", name: "NoTaxTotal", width: 150, align: 'left' },

                     { label: "每一品目应交税费", name: "NoTaxPrice", width: 150, align: 'left' },

                     { label: "每一品目含税价格", name: "TaxTotal", width: 150, align: 'left' },

                     { label: "税额", name: "Tax", width: 150, align: 'left', hidden: true },

                    {
                     	label: "设备状态", name: "EquipmentState", width: 150, align: 'left',
                     	formatter: function (cellvalue, options, rowObject) {
                     		if (rowObject.PayQuantity == rowObject.Quantity) {
                     			return '已到货';
                     		} else {
                     			return '未到货';
                     		}
                     	}
                    },

                     { label: "收货单位", name: "ReceivingUnit", width: 150, align: 'left' },

                     { label: "收货地址", name: "ShippingAddress", width: 150, align: 'left' },

                     { label: "收货地点", name: "PlaceOfReceipt", width: 150, align: 'left', hidden: true },

                     { label: "财务组织", name: "Financial", width: 150, align: 'left' },

                     { label: "客户", name: "Customer", width: 150, align: 'left' },

                     {
                        label: "已到货数量", name: "PayQuantity", width: 150, align: 'left',
                        formatter: function (cellvalue, options, rowObject) {
                            var arrival = rowObject.PayQuantity + rowObject.Unit
                            return arrival;
                        }
                     },

                     { label: "扣税类别", name: "TaxCategory", width: 150, align: 'left', hidden: true },

                     { label: "不可抵扣税率", name: "InvalidTaxRate", width: 150, align: 'left', hidden: true },

                     { label: "不可抵扣税额", name: "InvalidTaxPrice", width: 150, align: 'left', hidden: true },

                     { label: "计成本金额", name: "TotalCost", width: 150, align: 'left', hidden: true },

                     { label: "备注", name: "Remark", width: 150, align: 'left' },

                     { label: "入库时间", name: "StorageTime", width: 150, align: 'left', hidden: true },

                     { label: "出库时间", name: "OutboundTime", width: 150, align: 'left', hidden: true },

                     { label: "创建日期", name: "CreateDate", width: 150, align: 'left' },

                     { label: "创建用户账户", name: "CreateUserId", width: 150, align: 'left', hidden: true },

                     { label: "创建用户名称", name: "CreateUserName", width: 150, align: 'left' },

                     { label: "最后修改时间", name: "UpdateDate", width: 150, align: 'left', hidden: true },

                     { label: "最后修改用户", name: "UpdateUserId", width: 150, align: 'left', hidden: true },

                     { label: "最后修改用户名称", name: "UpdateUserName", width: 150, align: 'left', hidden: true }

            ],
            //data: colModels_Data,
            pager: "#" + subgrid_pager_id,
            sortname: 'CreateDate desc',
            datatype: "json"
            //rowNum: -1,
            //viewrecord: true
        });
    }


    function btn_add() {
        //$.modalOpen({
        //    id: "Form",
        //    title: "新增设备管理",
        //    url: "/TN_XM/TN_CG_CP/Form",
        //    width: ($(window).width() * 0.8) + "px",
        //    height: ($(window).height() * 0.7) + "px",
        //    callBack: function (iframeId) {
        //        top.frames[iframeId].submitForm();
        //    }
        //});
		var parentId = top.$.jfinetab.getCurrentTabId();
        top.$.jfinetab.addTabContent("/TN_XM/TN_CG_CP/Form3", "设备管理--新增", parentId + "_add", parentId);
    }
    function btn_edit() {
		//var keyValue = $("#gridList").jqGridRowValue().HTId;
        //if ($.checkedArray(keyValue))
        //{
		//	$.modalOpen({
		//		id: "Form",
		//		title: "修改设备管理",
		//		url: "/TN_XM/TN_CG_CP/Form?keyValue=" + keyValue,
		//		width: ($(window).width() * 0.8) + "px",
		//		 height: ($(window).height() * 0.7) + "px",
		//		callBack: function (iframeId) {
		//			top.frames[iframeId].submitForm();
		//		}
		//	});
        //}
		var parentId = top.$.jfinetab.getCurrentTabId();
        var Id = $("#gridList").jqGridRowValue().Id;
        if ($.checkedArray(Id)) {
            top.$.jfinetab.addTabContent("/TN_XM/TN_CG_CP/Form3?keyValue=" + Id, "设备管理--修改", parentId + "_edit", parentId);
        }
        
    }
    //function btn_CPedit() {
    //    var parentId = top.$.jfinetab.getCurrentTabId();
    //    var Id = $("#gridList").jqGridRowValue().Id;
    //    if ($.checkedArray(Id)) {
    //        top.$.jfinetab.addTabContent("/TN_XM/TN_CG_CP/Form?keyValue=" + Id, "设备管理--修改", parentId + "_edit", parentId);
    //    }
        
    //}
    function btn_delete() {
	  var keyValue = $("#gridList").jqGridRowValue().Id;
	 if ($.checkedArray(keyValue))
        {
			 $.deleteForm({
				url: "/TN_XM/TN_HT_CG/DeleteForm",
				param: { keyValue: keyValue },
				success: function () {
					$.currentWindow().$("#gridList").trigger("reloadGrid");
				}
			});
        }
        
    }

    //添加附件
    function btn_addfj() {
        var keyValue = $("#gridList").jqGridRowValue().Id;
        if ($.checkedArray(keyValue)) {
            var parentId = top.$.jfinetab.getCurrentTabId();
            top.$.jfinetab.addTabContent("/TN_XM/TN_HT_CG/DetailsFJ?keyValue=" + keyValue, "上传附件", parentId + "_details", parentId);
        }

    }

    function btn_details() { 
		var keyValue = $("#gridList").jqGridRowValue().Id;      
		//if ($.checkedArray(keyValue))
		// {
		//	$.modalOpen({
		//		id: "Details",
		//		title: "查看设备管理",
		//		url: "/TN_XM/TN_CG_CP/Details?keyValue=" + keyValue,
		//		width: "550px",
		//		height: "620px",
		//		btn: null,
		//	});
		//  }
		var parentId = top.$.jfinetab.getCurrentTabId();
		var Id = $("#gridList").jqGridRowValue().Id;
		if ($.checkedArray(Id)) {
		    top.$.jfinetab.addTabContent("/TN_XM/TN_HT_CG/Details?keyValue=" + Id, "采购合同管理--查看", parentId + "_view", parentId);
		}    
    }

    function btn_CPKPrint() {
        var parentId = top.$.jfinetab.getCurrentTabId();
        var keyValue = $("#gridList").jqGridRowValue().Id;
        if ($.checkedArray(keyValue)) {
            top.$.jfinetab.addTabContent("/TN_XM/TN_BB_DY/CPKPrint?keyValue=" + keyValue, "设备卡", parentId + "_edit", parentId);
        }
    }

    function btn_XMYSPrint() {
        var parentId = top.$.jfinetab.getCurrentTabId();
        var keyValue = $("#gridList").jqGridRowValue().Id;
        if ($.checkedArray(keyValue)) {
            top.$.jfinetab.addTabContent("/TN_XM/TN_BB_DY/XMYSPrint?keyValue=" + keyValue, "验收款", parentId + "_edit", parentId);
        }
    }

    function btn_LYBHPrint() {
        var parentId = top.$.jfinetab.getCurrentTabId();
        var keyValue = $("#gridList").jqGridRowValue().Id;
        if ($.checkedArray(keyValue)) {
            top.$.jfinetab.addTabContent("/TN_XM/TN_BB_DY/LYBHPrint?keyValue=" + keyValue, "履约保函", parentId + "_edit", parentId);
        }
    }

    function btn_CPTZPrint() {
        var parentId = top.$.jfinetab.getCurrentTabId();
        //var queryJson ={
        //    ProjectName: $("#ProjectName").val(),
        //    HTName: $("#HTName").val(),
        //    Name: $("#Name").val()
        //};
        var ProjectName = $("#ProjectName").val();
        var HTName = $("#HTName").val();
        var Name = $("#Name").val();
        top.$.jfinetab.addTabContent("/TN_XM/TN_BB_DY/CPTZPrint?ProjectName=" + ProjectName + "&HTName=" + HTName + "&Name=" + Name, "亚行项目设备台账", parentId + "_edit", parentId);
        
    }
    //采购合同付款
    function btn_Items() {
        var keyValue = $("#gridList").jqGridRowValue().Id;
        if ($.checkedArray(keyValue)) {
            $.modalOpen({
                id: "Items",
                title: "付款",
                url: "/TN_XM/TN_FK_MX/Form2?keyValue=" + keyValue,
                width: "1000px",
                height: "1200px",
                callBack: function (iframeId) {
                    top.frames[iframeId].submitForm();
                    $.reload();
                    //var parentTabId = top.$.jfinetab.getCurrentTabParentId();
                    //top.$.jfinetab.RefreshTabFromId(parentTabId);
                    //top.$.jfinetab.reload();
                }
            });
        }

    }
    //查看付款明细
    function btn_FKdetails() {
        var keyValue = $("#gridList").jqGridRowValue().Id;
        //var HTCode = $("#gridList").jqGridRowValue().Code;
        if ($.checkedArray(keyValue)) {
            $.modalOpen({
                id: "details",
                title: "查看付款明细",
                url: "/TN_XM/TN_FK_MX/Index2?keyValue=" + keyValue,
                width: "800px",
                height: "550px",
                btn: null,
                callBack: function (iframeId) {
                    top.frames[iframeId].submitForm();
                    //location.reload();
                    //var parentTabId = top.$.jfinetab.getCurrentTabParentId();
                    //top.$.jfinetab.RefreshTabFromId(parentTabId);
                    //top.$.jfinetab.reload();
                }
            });
        }
    }

    //采购合同金额汇总
    function btn_Sum() {
        //var ProjectNo = $("#gridList").jqGridRowValue().ProjectNo;
        $.modalOpen({
            id: "sum",
            title: "查看金额汇总",
            url: "/TN_XM/TN_CG_CP/AmountSum" ,
            width: "680px",
            height: "550px",
            btn: null,
            callBack: function (iframeId) {
                top.frames[iframeId].submitForm();
                //location.reload();
                //var parentTabId = top.$.jfinetab.getCurrentTabParentId();
                //top.$.jfinetab.RefreshTabFromId(parentTabId);
                //top.$.jfinetab.reload();
            }
        });
    }

    function btn_CGHTTZPrint() {
        var parentId = top.$.jfinetab.getCurrentTabId();
        var ProjectName = $("#ProjectName").val();
        var HTName = $("#HTName").val();
        var Name = $("#Name").val();
        top.$.jfinetab.addTabContent("/TN_XM/TN_BB_DY/CGHTTZPrint?ProjectName=" + ProjectName + "&HTName =" + HTName + "&Name=" + Name, "亚行合同台账", parentId + "_edit", parentId);

    }


    function btn_Bank() {
        var keyValue = $("#gridList").jqGridRowValue().Id;
        if ($.checkedArray(keyValue)) {
            var parentId = top.$.jfinetab.getCurrentTabId();
            top.$.jfinetab.addTabContent("/TN_XM/TN_HT_CG/BankFJ?keyValue=" + keyValue, "上传附件", parentId + "_details", parentId);
        }
    }

	function refreshGrid() {
        $("#gridList").trigger("reloadGrid");
	 }      
</script>
<div class="ui-layout-center">
    <div class="topPanel">
        <div class="search">
            <table>
                <tr>
                    <td style="padding-left:10px;">
                        <div class="input-group">
                            <input id="Code" type="text" class="form-control" placeholder="合同编号" style="width: 200px;">
                        </div>
                    </td>
                    <td style="padding-left:10px;"> 
                        <div class="input-group">
                            <input id="Name" type="text" class="form-control" placeholder="采购合同名称" style="width: 200px;">
                        </div>
                    </td>
                    <td style="padding-left:10px;">
                        <div class="input-group">
                            <input id="CPpackage" type="text" class="form-control" placeholder="设备包" style="width: 200px;">
                            <span class="input-group-btn">
                                <button id="btn_search" type="button" class="btn  btn-primary"><i class="fa fa-search"></i></button>
                            </span>
                        </div>
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <div class="topPanel" style="border: none;">
        <div class="toolbar">
            <div class="btn-group">
                <a class="btn btn-primary" onclick="$.reload()"><span class="glyphicon glyphicon-refresh"></span></a>
            </div>
            <div class="btn-group">
                @*<a id="JF-add" class="btn btn-primary dropdown-text" onclick="btn_add()"><i class="fa fa-plus"></i>新建</a>
        <a id="JF-edit" class="btn btn-primary dropdown-text" onclick="btn_edit()"><i class="fa fa-pencil-square-o"></i>修改</a>
        <a id="JF-delete" class="btn btn-primary dropdown-text" onclick="btn_delete()"><i class="fa fa-trash-o"></i>删除</a>
        <a id="JF-Details" class="btn btn-primary dropdown-text" onclick="btn_details()"><i class="fa fa-search-plus"></i>查看</a>
        <a id="JF-add" class="btn btn-primary dropdown-text" onclick="btn_addfj()"><i class="fa fa-plus"></i>添加附件</a>
        <a id="JF-print" class="btn btn-primary dropdown-text" onclick="btn_CPKPrint()"><i class="fa fa-plus"></i>设备卡</a>
        <a id="JF-print" class="btn btn-primary dropdown-text" onclick="btn_XMYSPrint()"><i class="fa fa-plus"></i>验收款</a>
        <a id="JF-print" class="btn btn-primary dropdown-text" onclick="btn_LYBHPrint()"><i class="fa fa-plus"></i>履约保函</a>
        <a id="JF-print" class="btn btn-primary dropdown-text" onclick="btn_CPTZPrint()"><i class="fa fa-plus"></i>设备台账</a>
        <a id="JF-print" class="btn btn-primary dropdown-text" onclick="btn_CGHTTZPrint()"><i class="fa fa-plus"></i>合同台账</a>*@
                @*<a id="JF-add" class="btn btn-primary dropdown-text" onclick="btn_FKdetails()"><i class="fa fa-plus"></i>查看明细</a>
        <a id="JF-add" class="btn btn-primary dropdown-text" onclick="btn_Items()" style="margin-left : 20px;"><i class="fa fa-plus"></i>付款</a>*@
                @*<a id="JF-print" class="btn btn-primary dropdown-text" onclick="btn_Sum()"><i class="fa fa-plus"></i>采购金额汇总</a>*@
                @*<a id="JF-print" class="btn btn-primary dropdown-text" onclick="btn_Bank()"><i class="fa fa-plus"></i>出入库单据管理</a>*@
            </div>
            <div id="toolbar" class="btn-group">
            </div>
            <script>$('#toolbar').authorizeButton()</script>
        </div>
    </div>
    <div class="gridPanel">
        <table id="gridList"></table>
        <div id="gridPager"></div>
    </div>
</div>
